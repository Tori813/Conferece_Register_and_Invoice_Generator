<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multiple Registration</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --border: rgba(0,0,0,0.08);
      --primary: #2563eb;
      --primary-600: #1e40af;
      --success: #16a34a;
      --shadow: 0 10px 20px rgba(0,0,0,0.08), 0 6px 6px rgba(0,0,0,0.06);
    }

    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial; margin: 0; background: var(--bg); color: var(--text); }
    .page { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; }
    .card { width: 100%; max-width: 720px; background: var(--card); border-radius: 16px; box-shadow: var(--shadow); padding: 26px; border: 1px solid var(--border); }
    h2 { margin: 0 0 16px; font-size: 24px; letter-spacing: .2px; color: #2563eb; }
    h4 { margin: 14px 0 10px; color: #2563eb; font-size: 14px; font-weight: 600; }

    .form-group { margin-bottom: 14px; }
    label { display: block; font-size: 14px; color: #2563eb; margin-bottom: 6px; }
    input[type="text"], input[type="email"], input[type="tel"], select {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: #fff; color: var(--text);
      outline: none; transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15); }

    .email-entry { display: grid; grid-template-columns: 1fr 1fr; column-gap: 14px; row-gap: 12px; margin: 18px 0; }
    .email-entry > * { width: 100%; margin: 0; }
    .email-entry input[type="email"],
    .email-entry .form-group,
    .email-entry select,
    .email-entry .static-field,
    .email-entry .exhibitions-container { 
      grid-column: span 2; 
      width: 100%;
      margin-bottom: 14px;
    }
    .email-entry .form-group { margin-bottom: 0; }
    .email-entry .form-group label { margin-bottom: 6px; display: block; }
    .email-entry select,
    .email-entry .static-field {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      font-size: 14px;
      height: 42px;
      box-sizing: border-box;
    }
    .email-entry .static-field {
      background: #f9fafb;
      color: var(--muted);
      display: flex;
      align-items: center;
    }
    @media (max-width: 640px) {
      .email-entry { 
        grid-template-columns: 1fr; 
        row-gap: 14px;
      }
      .email-entry input[type="email"],
      .email-entry .form-group,
      .email-entry select,
      .email-entry .static-field,
      .email-entry .exhibitions-container { 
        grid-column: span 1; 
      }
    }
/* 
  Author: Victoria Okello
  Project: Conference Registration System 
  Year: 2025
*/

    /* Static field styling to look like a disabled input */
    .static-field {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border);
      background: #f9fafb; color: var(--muted);
    }

    .actions { display: flex; align-items: center; gap: 10px; margin-top: 16px; }
    .btn { appearance: none; border: 0; border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { filter: brightness(1.05); }
    .btn-primary:active { transform: translateY(1px); }
    .add-btn { background: var(--success); color: #fff; border: 0; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
    .add-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Inline messages */
    .alert { padding: 10px 12px; border-radius: 10px; margin-bottom: 12px; font-size: 14px; }
    .alert-success { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; }
    .alert-error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
    .invalid { border-color: #ef4444 !important; box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15) !important; }
  </style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <div class="page">
    <div class="card">
      <h2>Multiple Registration</h2>
      <div id="msg" aria-live="polite"></div>

      <form id="multipleForm">
      <div class="form-group">
        <label for="primaryEmail">Primary Email:</label>
        <input type="email" id="primaryEmail" name="primaryEmail" autocomplete="email" placeholder="Enter primary email" required>
      </div>
      <div id="primaryDetails" style="display:none;">
        <div class="form-group">
          <label for="primaryfirstName">Primary First Name:</label>
          <input type="text" id="primaryfirstName" name="primaryfirstName" autocomplete="name" placeholder="Enter first name" required>
        </div>
        <div class="form-group">
          <label for="primarysurname">Primary Surname:</label>
          <input type="text" id="primarysurname" name="primarysurname" autocomplete="name" placeholder="Enter surname" required>
        </div>
        <div class="form-group">
          <label for="primaryposition">Primary Position:</label>
          <input type="text" id="primaryposition" name="primaryposition" autocomplete="name" placeholder="Enter position" required>
        </div>
        <div class="form-group">
          <label for="primaryPhone">Primary Phone:</label>
          <input type="tel" id="primaryPhone" name="primaryPhone" autocomplete="tel" placeholder="Enter phone number" required>
        </div>
        <div class="form-group">
          <label for="primaryOrganization">Primary Organization:</label>
          <input type="text" id="primaryOrganization" name="primaryOrganization" autocomplete="organization" placeholder="Enter organization name" required>
        </div>
        <div class="form-group">
          <label for="participantType">Type of Participant:</label>
          <select id="participantType" required>
            <option value="" disabled selected>Select type of participant</option>
            <option value="nonResidential">Non Residential</option>
            <option value="residential">Residential</option>
            <option value="hybridParticipant">Hybrid Participant</option>
          </select>
        </div>

        <!-- Exhibition Options -->
        <div class="form-group">
          <div id="exhibitionsLabel">Exhibition Options</div>
          <div id="exhibitionsContainer" class="exhibitions-container">
            <div class="exhibition-row" style="display: flex; gap: 12px; margin-bottom: 12px; align-items: flex-end;">
              <div style="flex: 2;">
                <label for="primaryExhibitionDetail">Exhibition Details:</label>
                <input type="text" id="primaryExhibitionDetail" name="exhibitions[]" class="exhibition-detail" placeholder="Enter exhibition details" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
         </div>
         <div style="flex: 1;">
              <label for="exhibitionAmount">Amount (KES):</label>
              <input type="number" id="exhibitionAmount" name="exhibitionAmounts[]" class="exhibition-amount" placeholder="Enter amount" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
          </div>
              <button type="button" class="add-exhibition" style="margin-bottom: 6px; padding: 0; background: #4CAF50; border: none; border-radius: 4px; color: white; cursor: pointer; width: 32px; height: 38px; display: flex; align-items: center; justify-content: center;">
              <span style="font-size: 20px; line-height: 1;">+</span>
              </button>
          </div>
          </div>
       </div>

        <div class="form-group">
          <label for="primaryCategory">Primary Category:</label>
          <select id="primaryCategory" name="primaryCategory" required>
            <option value="" disabled selected>Select category</option>
            <option value="participant">Participant</option>
            <option value="speaker">Speaker</option>
          </select>
        </div>
        
        <!-- Speaker Specific Fields -->
        <div id="speakerFields" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border);">
          <h3 style="margin: 0 0 15px 0; font-size: 18px; color: var(--primary);">Speaker Information</h3>
          
          <div class="form-group">
            <div id="subThemeLabel">Proposed Sub-Theme:</div>
            <div style="margin-top: 8px;">
              <div style="margin-bottom: 8px;">
                <input type="radio" id="theme1" name="subTheme" value="Agri-Finance for Resilient Food Systems (investment) - KCV">
                <label for="theme1" style="display: inline; margin-left: 8px;">Agri-Finance for Resilient Food Systems (investment) - KCV</label>
              </div>
              <div style="margin-bottom: 8px;">
                <input type="radio" id="theme2" name="subTheme" value="Climate Change Adaptation & Green Transformation - Sustainable & Regenerative Agriculture – Ripple & MESPT">
                <label for="theme2" style="display: inline; margin-left: 8px;">Climate Change Adaptation & Green Transformation - Sustainable & Regenerative Agriculture – Ripple & MESPT</label>
              </div>
              <div style="margin-bottom: 8px;">
                <input type="radio" id="theme3" name="subTheme" value="Market Systems, Trade & Regional Integration - Private Sector Engagement & Partnerships - (investment) – Migingo, MEDA & TMA">
                <label for="theme3" style="display: inline; margin-left: 8px;">Market Systems, Trade & Regional Integration - Private Sector Engagement & Partnerships - (investment) – Migingo, MEDA & TMA</label>
              </div>
              <div style="margin-bottom: 8px;">
                <input type="radio" id="theme4" name="subTheme" value="Gender Equality & Social Inclusion (GESI) + Disability - Youth & Future Market Systems Leadership – Christian Aid & Tanager">
                <label for="theme4" style="display: inline; margin-left: 8px;">Gender Equality & Social Inclusion (GESI) + Disability - Youth & Future Market Systems Leadership – Christian Aid & Tanager</label>
              </div>
              <div style="margin-bottom: 8px;">
                <input type="radio" id="theme5" name="subTheme" value="Measuring Systemic Change & Policy Influence – IFDC">
                <label for="theme5" style="display: inline; margin-left: 8px;">Measuring Systemic Change & Policy Influence – IFDC</label>
              </div>
              <div style="margin-bottom: 8px;">
                <input type="radio" id="theme6" name="subTheme" value="Innovation & Scale – IDE & Heifer">
                <label for="theme6" style="display: inline; margin-left: 8px;">Innovation & Scale – IDE & Heifer</label>
              </div>
              <div style="margin-bottom: 8px;">
                <input type="radio" id="theme7" name="subTheme" value="Others">
                <label for="theme7" style="display: inline; margin-left: 8px;">Others</label>
                <input type="text" id="otherTheme" name="otherTheme" style="display: none; margin-left: 25px; width: calc(100% - 50px); margin-top: 5px; padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border);" placeholder="Please specify your theme">
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="emailContainer" style="display:none;">
        <h4>Additional Emails</h4>
        <div id="emails"></div>
        <button type="button" class="add-btn" id="addBtn" disabled>+ Add Email</button>
      </div>
      <button type="submit" class="btn btn-primary" style="margin-top: 10px;">Submit</button>
      </form>
    </div>
  </div>
<!-- 
  Conference Registration System
  Author: Victoria Okello
  Created: 2025
  Ownership: This code is authored by Victoria Okello.
-->

  <script>
    function updateAddBtnState() {
  const addBtn = document.getElementById('addBtn');
  if (!addBtn) return;

  const primaryEmail = document.getElementById('primaryEmail')?.value.trim();
  const primaryFirstName = document.getElementById('primaryfirstName')?.value.trim();
  const primarySurname = document.getElementById('primarysurname')?.value.trim();
  const primaryPhone = document.getElementById('primaryPhone')?.value.trim();
  const primaryOrg = document.getElementById('primaryOrganization')?.value.trim();
  const primaryCat = document.getElementById('primaryCategory')?.value;

  const allFilled = primaryEmail && primaryFirstName && primarySurname && primaryPhone && primaryOrg && primaryCat;
  addBtn.disabled = !allFilled;
}

    // Simple message helper
    function showMessage(type, text) {
      const box = document.getElementById('msg');
      box.className = 'alert ' + (type === 'success' ? 'alert-success' : 'alert-error');
      box.textContent = text;
    }

    // Check whether primary info is valid
    function isPrimaryValid() {
      const requiredFields = [
        'primaryEmail',
        'primaryfirstName',
        'primarysurname',
        'primaryPhone',
        'primaryOrganization',
        'primaryCategory'
      ];
      
      // Check required fields
      const allFieldsValid = requiredFields.every(id => {
        const el = document.getElementById(id);
        return el && el.value.trim() !== '';
      });
      
      // If category is speaker, check if a sub-theme is selected
      const category = document.getElementById('primaryCategory')?.value;
      if (category === 'speaker') {
        const subThemeSelected = Array.from(document.getElementsByName('subTheme')).some(radio => radio.checked);
        if (!subThemeSelected) {
          return false;
        }
        
        // Check if "Others" is selected and has a value
        const otherRadio = document.querySelector('input[name="subTheme"][value="Others"]');
        const otherThemeInput = document.getElementById('otherTheme');
        if (otherRadio?.checked && (!otherThemeInput || !otherThemeInput.value.trim())) {
          return false;
        }
      }
      
      return allFieldsValid;
    }

    async function generateInvoice(payload) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const now = new Date();
  const pageWidth = doc.internal.pageSize.getWidth();

  const invNo = "INV-" + now.getFullYear() +
    String(now.getMonth() + 1).padStart(2, "0") +
    String(now.getDate()).padStart(2, "0") + "-" +
    String(now.getHours()).padStart(2, "0") +
    String(now.getMinutes()).padStart(2, "0") +
    String(now.getSeconds()).padStart(2, "0");

  // Logo
  try {
    const img = new Image();
    img.src = "Mespt_logo.png";
    await new Promise((res, rej) => { img.onload = res; img.onerror = rej; });
    doc.addImage(img, "PNG", (pageWidth - 50) / 2, 8, 50, 25);
  } catch {}

  // Header
  doc.setFontSize(18);
  doc.text("INVOICE", pageWidth / 2, 40, { align: "center" });
  doc.setFontSize(10);
  doc.text(`Date: ${now.toLocaleDateString()}`, pageWidth - 70, 20);
  doc.text(`Invoice No: ${invNo}`, pageWidth - 70, 26);

  // Organization info
  let y = 55;
  doc.setFontSize(10);
  doc.text("Micro Enterprises Support Programme Trust", 14, y); y += 6;
  doc.text("Tausi Lane, Between Muthithi Rd & Westlands Rd, Gate 01", 14, y); y += 6;
  doc.text("P.O BOX 187 – 00606- Sarit Centre", 14, y); y += 6;
  doc.text("Nairobi", 14, y); y += 6;
  doc.text("Tel: +254722207905; info@mespt.org", 14, y); y += 10;

  // Bill To
  doc.setFont("helvetica", "bold");
  doc.text("Bill To:", 14, y); y += 8;
  doc.setFont("helvetica", "normal");

  const fullName = `${payload.primary.firstName} ${payload.primary.surname}`;
  if (payload.primary.organization) doc.text(payload.primary.organization, 14, y), y += 6;
  if (payload.primary.phone) doc.text(`Tel: ${payload.primary.phone}`, 14, y), y += 6;
  if (fullName) doc.text(fullName, 14, y), y += 6;
  if (payload.primary.position) doc.text(payload.primary.position, 14, y), y += 6;
  if (payload.primary.email) doc.text(`Email: ${payload.primary.email}`, 14, y), y += 10;
  doc.text("Ref: 2025 BDCG Inclusive Market Symposium", 14, y); y += 12;

  // Fee map
  const feeMap = {
    nonresidential: { amount: 1000, label: 'Non-Residential Participant' },
    residential: { amount: 1500, label: 'Residential Participant' },
    hybridparticipant: { amount: 1200, label: 'Hybrid Participant' }
  };

  // Items header
  doc.setFontSize(12);
  doc.text("Items", 14, y); y += 6;
  doc.setFontSize(10);
  doc.setFillColor(220, 230, 241);
  doc.rect(14, y, 182, 10, 'F');
  doc.text("Description", 16, y + 7);
  doc.text("Amount (KES)", 170, y + 7, { align: "right" });
  y += 15;

  let total = 0;

  function addParticipantItems(p, label) {
    const type = p.participantType?.toLowerCase() || "";
    const feeInfo = feeMap[type] || { amount: 0, label: 'Participant' };
    const participantLabel = label === 'Primary' ? 'Primary ' + feeInfo.label : `${label} (${feeInfo.label})`;

    // Participant fee
    doc.text(participantLabel, 16, y);
    doc.text(feeInfo.amount.toLocaleString(), 170, y, { align: "right" });
    y += 10;
    total += feeInfo.amount;

    // Exhibitions
    if (p.exhibitions && p.exhibitions.length) {
      p.exhibitions.forEach(ex => {
        doc.text(`• ${ex.detail}`, 20, y);
        doc.text(parseInt(ex.amount).toLocaleString(), 170, y, { align: "right" });
        y += 10;
        total += parseInt(ex.amount);
      });
    }

    // Speaker sub-theme (for both primary and additional attendees)
    if (p.category === "speaker" && p.subTheme) {
      doc.setFont("helvetica", "italic");
      doc.text(`Speaker Sub-Theme: ${p.subTheme}`, 16, y);
      doc.setFont("helvetica", "normal");
      y += 10;
    }

    // Subtotal
    doc.setFont("helvetica", "bold");
    doc.text(`Subtotal for ${label}:`, 16, y);
    const participantTotal = (p.exhibitions || []).reduce((sum, ex) => sum + parseInt(ex.amount), feeInfo.amount);
    doc.text(participantTotal.toLocaleString(), 170, y, { align: "right" });
    doc.setFont("helvetica", "normal");
    y += 15;
  }

  // Primary
  addParticipantItems(payload.primary, "Primary");

  // Additionals
  (payload.additional || []).forEach((p, i) => {
    // Ensure additional attendees have access to their sub-theme if they are speakers
    if (p.category === 'speaker' && !p.subTheme && payload.primary.subTheme) {
      p.subTheme = payload.primary.subTheme; // Use primary's sub-theme if not set
    }
    addParticipantItems(p, `Additional ${i + 1}`);
  });

  // Total line
  doc.line(14, y, 196, y); y += 6;
  doc.setFont("helvetica", "bold");
  doc.text("Total:", 16, y);
  doc.text(total.toLocaleString(), 170, y, { align: "right" });
  y += 15;

  // Bank details
  doc.setFontSize(10);
  doc.text("Bank Account Details:", 14, y); y += 7;
  doc.text("Bank Name: KCB", 16, y); y += 6;
  doc.text("Branch Name: Sarit Centre", 16, y); y += 6;
  doc.text("Account Name: MESPT BUSINESS SERVICES", 16, y); y += 6;
  doc.text("Account Number: 1129775283", 16, y); y += 6;
  doc.text("Swift Address: KCBLKENX", 16, y); y += 15;

  // Save + send
  const safeName = fullName.replace(/[^a-z0-9]/gi, "_").toLowerCase() || "invoice";
  const fileName = `${invNo}-${safeName}.pdf`;
  doc.save(fileName);

  const formData = new FormData();
  formData.append("email", payload.primary.email);
  formData.append("name", fullName);
  formData.append("invoice_number", invNo);
  formData.append("pdf", doc.output("blob"), fileName);

  await fetch("send_invoice.php", { method: "POST", body: formData });
  return { success: true, total: total };
}

   if (window.console) {
    console.log("%cMade by Victoria Okello © 2025", "color: purple; font-size: 14px;");
     }

    // Add exhibition row
    function addExhibitionRow() {
      const container = document.getElementById('exhibitionsContainer');
      const newRow = document.createElement('div');
      newRow.className = 'exhibition-row';
      newRow.style = 'display: flex; gap: 12px; margin-bottom: 12px; align-items: flex-end;';
      
      newRow.innerHTML = `
        <div style="flex: 2;">
          <input type="text" name="exhibitions[]" class="exhibition-detail" placeholder="Enter exhibition details" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
        </div>
        <div style="flex: 1;">
          <input type="number" name="exhibitionAmounts[]" class="exhibition-amount" placeholder="Enter amount" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
        </div>
        <button type="button" class="remove-exhibition" style="margin-bottom: 6px; padding: 0; background: #f44336; border: none; border-radius: 4px; color: white; cursor: pointer; width: 32px; height: 38px; display: flex; align-items: center; justify-content: center;">
          <span style="font-size: 20px; line-height: 1;">×</span>
        </button>
      `;
      
      container.appendChild(newRow);
      
      // Add event listener to the new remove button
      const removeBtn = newRow.querySelector('.remove-exhibition');
      removeBtn.addEventListener('click', function() {
        container.removeChild(newRow);
      });
    }

    // Handle add exhibition button clicks
    document.addEventListener('click', function(e) {
      if (e.target.closest('.add-exhibition')) {
        addExhibitionRow();
      }
    });

    // Toggle speaker fields based on category selection
    document.getElementById('primaryCategory').addEventListener('change', function() {
      const speakerFields = document.getElementById('speakerFields');
      const subThemeRadios = document.getElementsByName('subTheme');
      
      if (this.value === 'speaker') {
        speakerFields.style.display = 'block';
        // Make sub-theme required when speaker is selected
        subThemeRadios.forEach(radio => radio.required = true);
      } else {
        speakerFields.style.display = 'none';
        // Remove required when not speaker
        subThemeRadios.forEach(radio => radio.required = false);
      }
      updateAddBtnState(); // Update button state when category changes
    });

    // Toggle 'Other' text field for speaker themes
    document.addEventListener('change', function(e) {
      if (e.target.name === 'subTheme') {
        const otherThemeInput = document.getElementById('otherTheme');
        if (e.target.value === 'Others') {
          otherThemeInput.style.display = 'block';
          otherThemeInput.setAttribute('required', '');
        } else {
          otherThemeInput.style.display = 'none';
          otherThemeInput.removeAttribute('required');
          otherThemeInput.value = '';
        }
      }
    });

    // Show primary details and email container after primary email is entered
    document.getElementById('primaryEmail').addEventListener('blur', () => {
      const hasPrimary = !!document.getElementById('primaryEmail').value;
      if (hasPrimary) {
        const details = document.getElementById('primaryDetails');
        const emailContainer = document.getElementById('emailContainer');
        if (details) {
          details.style.display = 'block';
          // Make name and phone required only once visible
          const nameEl = document.getElementById('primaryName');
          const phoneEl = document.getElementById('primaryPhone');
          const catEl = document.getElementById('primaryCategory');
          const orgEl = document.getElementById('primaryOrganization');
          if (nameEl) nameEl.required = true;
          if (phoneEl) phoneEl.required = true;
          if (catEl) catEl.required = true;
          if (orgEl) orgEl.required = true;
        }
        if (emailContainer) emailContainer.style.display = 'block';
      }
      updateAddBtnState();
    });

    // Keep add button state updated when primary fields change
    ['primaryName','primaryPhone','primaryOrganization','primaryCategory'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', updateAddBtnState);
    });

    // Add new email + details
    function addEmail() {
      // Gate: ensure primary is complete
      if (!isPrimaryValid()) {
        showMessage('error', 'Complete primary information before adding additional entries.');
        return;
      }
      const div = document.createElement('div');
      div.classList.add('email-entry');
      const entryId = 'entry_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
      div.innerHTML = `
        <input type="email" id="${entryId}_email" name="additionalEmails[]" placeholder="Enter email" autocomplete="email" required>
        <input type="text" id="${entryId}_name" name="additionalNames[]" placeholder="Full Name" autocomplete="name" required>
        <input type="text" id="${entryId}_position" name="additionalPositions[]" placeholder="Position" autocomplete="organization-title" required>
        <input type="tel" id="${entryId}_phone" name="additionalPhones[]" placeholder="Phone" autocomplete="tel" required>
        <div class="form-group">
          <label for="${entryId}_org">Organization:</label>
          <input type="text" id="${entryId}_org" name="organization[]" placeholder="Enter organization" autocomplete="organization" required>
        </div>
        
        <!-- Participant Type -->
        <div class="form-group">
          <label>Type of Participant:</label>
          <select name="participantTypes[]" required>
            <option value="" disabled selected>Select type of participant</option>
            <option value="nonResidential">Non Residential</option>
            <option value="residential">Residential</option>
            <option value="hybridParticipant">Hybrid Participant</option>
          </select>
        </div>
        
        <!-- Category -->
        <label>Category:</label>
        <select id="${entryId}_category" name="additionalCategories[]" class="category-select" required>
          <option value="" disabled selected>Select category</option>
          <option value="participant">Participant</option>
          <option value="speaker">Speaker</option>
        </select>
        
        <!-- Speaker Specific Fields -->
        <div class="speaker-fields" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border);">
          <h3 style="margin: 0 0 15px 0; font-size: 18px; color: var(--primary);">Speaker Information</h3>
          
          <div class="form-group">
            <div class="sub-theme-label">Proposed Sub-Theme:</div>
            <div style="margin-top: 8px;">
              <div style="margin-bottom: 8px;">
                <input type="radio" id="${entryId}_theme1" name="subTheme_${entryId}" value="Agri-Finance for Resilient Food Systems (investment) - KCV">
                <label for="${entryId}_theme1" style="display: inline; margin-left: 8px;">Agri-Finance for Resilient Food Systems (investment) - KCV</label>
              </div>
              <div style="margin-bottom: 8px;">
                <input type="radio" id="${entryId}_theme2" name="subTheme_${entryId}" value="Climate Change Adaptation & Green Transformation - Sustainable & Regenerative Agriculture – Ripple & MESPT">
                <label for="${entryId}_theme2" style="display: inline; margin-left: 8px;">Climate Change Adaptation & Green Transformation - Sustainable & Regenerative Agriculture – Ripple & MESPT</label>
              </div>
              <div style="margin-bottom: 8px;">
                <input type="radio" id="${entryId}_theme3" name="subTheme_${entryId}" value="Market Systems, Trade & Regional Integration - Private Sector Engagement & Partnerships - (investment) – Migingo, MEDA & TMA">
                <label for="${entryId}_theme3" style="display: inline; margin-left: 8px;">Market Systems, Trade & Regional Integration - Private Sector Engagement & Partnerships - (investment) – Migingo, MEDA & TMA</label>
              </div>
              <div style="margin-bottom: 8px;">
                <input type="radio" id="${entryId}_theme4" name="subTheme_${entryId}" value="Gender Equality & Social Inclusion (GESI) + Disability - Youth & Future Market Systems Leadership – Christian Aid & Tanager">
                <label for="${entryId}_theme4" style="display: inline; margin-left: 8px;">Gender Equality & Social Inclusion (GESI) + Disability - Youth & Future Market Systems Leadership – Christian Aid & Tanager</label>
              </div>
              <div style="margin-bottom: 8px;">
                <input type="radio" id="${entryId}_theme5" name="subTheme_${entryId}" value="Measuring Systemic Change & Policy Influence – IFDC">
                <label for="${entryId}_theme5" style="display: inline; margin-left: 8px;">Measuring Systemic Change & Policy Influence – IFDC</label>
              </div>
              <div style="margin-bottom: 8px;">
                <input type="radio" id="${entryId}_theme6" name="subTheme_${entryId}" value="Innovation & Scale – IDE & Heifer">
                <label for="${entryId}_theme6" style="display: inline; margin-left: 8px;">Innovation & Scale – IDE & Heifer</label>
              </div>
              <div style="margin-bottom: 8px;">
                <input type="radio" id="${entryId}_theme7" name="subTheme_${entryId}" value="Others">
                <label for="${entryId}_theme7" style="display: inline; margin-left: 8px;">Others</label>
                <input type="text" id="${entryId}_otherTheme" name="otherTheme_${entryId}" style="display: none; margin-left: 25px; width: calc(100% - 50px); margin-top: 5px; padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border);" placeholder="Please specify your theme">
              </div>
            </div>
          </div>
        </div>
        
        <!-- Exhibition Options -->
        <div class="form-group">
          <div class="exhibition-options-label">Exhibition Options</div>
          <div class="exhibitions-container">
            <div class="exhibition-row" style="display: flex; gap: 12px; margin-bottom: 12px; align-items: flex-end;">
              <div style="flex: 2;">
                <label for="exhibitionDetail_${entryId}">Exhibition Details:</label>
                <input type="text" id="exhibitionDetail_${entryId}" name="exhibitions[]" class="exhibition-detail" placeholder="Enter exhibition details" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              </div>
              <div style="flex: 1;">
                <label for="exhibitionAmount_${entryId}">Amount (KES):</label>
                <input type="number" id="exhibitionAmount_${entryId}" name="exhibitionAmounts[]" class="exhibition-amount" placeholder="Enter amount" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              </div>
              <button type="button" class="add-exhibition" style="margin-bottom: 6px; padding: 0; background: #4CAF50; border: none; border-radius: 4px; color: white; cursor: pointer; width: 32px; height: 38px; display: flex; align-items: center; justify-content: center;">
                <span style="font-size: 20px; line-height: 1;">+</span>
              </button>
            </div>
          </div>
        </div>
        
        <input type="hidden" class="org-hidden" name="organization[]" value="">
      `;
      document.getElementById('emails').appendChild(div);
      
      // Add event listener for category change to show/hide speaker fields
      const categorySelect = div.querySelector('.category-select');
      if (categorySelect) {
        categorySelect.addEventListener('change', function() {
          const speakerFields = div.querySelector('.speaker-fields');
          if (speakerFields) {
            speakerFields.style.display = this.value === 'speaker' ? 'block' : 'none';
          }
        });
      }
      
      // Add event listener for 'Others' radio button in speaker fields
      div.addEventListener('change', function(e) {
        if (e.target.name && e.target.name.startsWith('subTheme_') && e.target.value === 'Others') {
          const otherThemeInput = div.querySelector('input[type="text"][name^="otherTheme_"]');
          if (otherThemeInput) {
            otherThemeInput.style.display = 'block';
            otherThemeInput.required = true;
          }
        } else if (e.target.name && e.target.name.startsWith('subTheme_')) {
          const otherThemeInput = div.querySelector('input[type="text"][name^="otherTheme_"]');
          if (otherThemeInput) {
            otherThemeInput.style.display = 'none';
            otherThemeInput.required = false;
            otherThemeInput.value = '';
          }
        }
      });
      
      // After adding, sync organization value and lock editing
      syncOrgToChildren();
    }

    document.getElementById('addBtn').addEventListener('click', addEmail);

    // Track if organization fields have been manually edited
    const orgFieldEdited = new Set();
    
    // Sync organization from primary to all additional entries that haven't been manually edited
    function syncOrgToChildren() {
      const primaryOrg = document.getElementById('primaryOrganization').value.trim();
      document.querySelectorAll('.additional-org').forEach(orgInput => {
        const container = orgInput.closest('.email-container');
        const index = container.dataset.index;
        if (!orgFieldEdited.has(`org_${index}`)) {
          orgInput.value = primaryOrg;
        }
      });
    }
    
    // Listen for changes to the primary organization
    document.getElementById('primaryOrganization').addEventListener('input', syncOrgToChildren);
    
    // Track manual edits to organization fields
    document.addEventListener('input', (e) => {
      if (e.target.classList.contains('additional-org')) {
        const container = e.target.closest('.email-container');
        const index = container.dataset.index;
        orgFieldEdited.add(`org_${index}`);
      }
    });

    // Handle form submission -> POST to PHP endpoint with inline validation
    document.getElementById('multipleForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.currentTarget;
  document.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));

  // Collect exhibitions for primary
  const primaryExhibitions = [];
  document.querySelectorAll('#exhibitionsContainer .exhibition-row').forEach(row => {
    const detail = row.querySelector('.exhibition-detail')?.value.trim();
    const amount = row.querySelector('.exhibition-amount')?.value.trim();
    if (detail && amount) primaryExhibitions.push({ detail, amount });
  });

  // Primary payload
  const payload = {
    type: 'multiple',
    primary: {
      email: document.getElementById('primaryEmail').value.trim(),
      firstName: document.getElementById('primaryfirstName').value.trim(),
      surname: document.getElementById('primarysurname').value.trim(),
      phone: document.getElementById('primaryPhone').value.trim(),
      position: document.getElementById('primaryposition')?.value?.trim() || '',
      organization: document.getElementById('primaryOrganization').value.trim(),
      category: document.getElementById('primaryCategory').value,
      participantType: document.getElementById('participantType').value,
      subTheme: document.querySelector('input[name="subTheme"]:checked')?.value || '',
      exhibitions: primaryExhibitions
    },
    additional: []
  };

    // Additional participants
    document.querySelectorAll('#emails .email-entry').forEach(entry => {
      const email = entry.querySelector('input[type="email"]')?.value?.trim() || '';
      const name = entry.querySelector('input[type="text"]:not([name^="additionalPositions"])')?.value?.trim() || '';
      const position = entry.querySelector('input[name^="additionalPositions"]')?.value?.trim() || '';
      const phone = entry.querySelector('input[type="tel"]')?.value?.trim() || '';
      const organization = entry.querySelector('input[name="organization[]"]')?.value?.trim() || '';
      const category = entry.querySelector('select[name="additionalCategories[]"]')?.value || '';
      const participantType = entry.querySelector('select[name="participantTypes[]"]')?.value || '';
      
      // Get the selected sub-theme for this attendee
      let subTheme = '';
      const selectedTheme = entry.querySelector('input[name^="subTheme_"]:checked');
      if (selectedTheme) {
        if (selectedTheme.value === 'Others') {
          // If 'others' is selected, get the custom theme text
          const otherThemeInput = entry.querySelector('input[type="text"][name^="otherTheme_"]');
          if (otherThemeInput) {
            subTheme = otherThemeInput.value.trim();
          }
        } else {
          subTheme = selectedTheme.value;
        }
      }

      // Exhibitions for this participant
      const exhibitions = [];
      entry.querySelectorAll('.exhibition-row').forEach(row => {
        const detail = row.querySelector('.exhibition-detail')?.value.trim();
        const amount = row.querySelector('.exhibition-amount')?.value.trim();
        if (detail && amount) exhibitions.push({ detail, amount });
      });

      payload.additional.push({ 
        email, 
        name, 
        position,
        phone, 
        organization, 
        category, 
        participantType, 
        subTheme,
        exhibitions 
      });
  });

  try {
    const res = await fetch('save_registration.php', {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (data.message) {
      showMessage('success', data.message);
      const invoiceResult = await generateInvoice(payload);
      // Update payload with total amount before saving
      payload.totalAmount = invoiceResult.total;
      // Send the registration data again with the total amount
      await fetch('save_registration.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      form.reset();
      document.getElementById('primaryDetails').style.display = 'none';
      document.getElementById('emailContainer').style.display = 'none';
      document.getElementById('emails').innerHTML = '';
      updateAddBtnState();
    } else {
      showMessage('error', data.error || 'Failed to save registration.');
    }
  } catch (err) {
    showMessage('error', 'Network error. Please try again.');
    console.error(err);
  }
});

  </script>
</body>
</html>
