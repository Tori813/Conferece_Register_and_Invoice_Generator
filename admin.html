<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registrations Admin</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --border: rgba(0,0,0,0.08);
      --primary: #2563eb;
      --shadow: 0 10px 20px rgba(0,0,0,0.08), 0 6px 6px rgba(0,0,0,0.06);
    }

    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial; background: var(--bg); color: var(--text); }
    .container { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; box-shadow: var(--shadow); padding: 18px; }
    h1 { margin: 0 0 14px; font-size: 24px; }

    .controls { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 12px; }
    .controls input, .controls select, .controls button { height: 38px; padding: 8px 10px; border: 1px solid var(--border); border-radius: 10px; }
    .controls button { background: var(--primary); color: #fff; font-weight: 600; cursor: pointer; }

    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; }
    th { background: #f9fafb; font-weight: 600; }
    .muted { color: var(--muted); }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; background: #eef2ff; color: #3730a3; }
    .empty { text-align: center; padding: 24px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Registrations</h1>
      <div class="controls">
        <input id="search" type="text" placeholder="Search name, email, org..." />
        <select id="typeFilter">
          <option value="">All Types</option>
          <option value="single">Single</option>
          <option value="multiple">Multiple</option>
        </select>
        <select id="categoryFilter">
          <option value="">All Categories</option>
          <option value="attendee">Attendee</option>
          <option value="speaker">Speaker</option>
          <option value="sponsor">Sponsor</option>
          <option value="staff">Staff</option>
        </select>
        <button id="exportBtn">Export CSV</button>
        <button id="refreshBtn" type="button">Refresh</button>
      </div>

      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Type</th>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Organization</th>
              <th>Category</th>
              <th class="muted">Created</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td class="empty" colspan="7">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let allRows = [];

    function normalizeMultiple(rec) {
      const rows = [];
      if (rec.primary) {
        rows.push({
          type: 'multiple',
          name: rec.primary.name || '',
          email: rec.primary.email || '',
          phone: rec.primary.phone || '',
          organization: rec.primary.organization || '',
          category: rec.primary.category || '',
          created_at: rec.created_at || ''
        });
      }
      if (Array.isArray(rec.additional)) {
        for (const a of rec.additional) {
          rows.push({
            type: 'multiple',
            name: a.name || '',
            email: a.email || '',
            phone: a.phone || '',
            organization: a.organization || '',
            category: a.category || '',
            created_at: rec.created_at || ''
          });
        }
      }
      return rows;
    }

    function render(rows) {
      const tbody = document.getElementById('tbody');
      if (!rows.length) {
        tbody.innerHTML = '<tr><td class="empty" colspan="7">No registrations found</td></tr>';
        return;
      }
      tbody.innerHTML = rows.map(r => `
        <tr>
          <td><span class="badge">${r.type || ''}</span></td>
          <td>${escapeHtml(r.name || '')}</td>
          <td>${escapeHtml(r.email || '')}</td>
          <td>${escapeHtml(r.phone || '')}</td>
          <td>${escapeHtml(r.organization || '')}</td>
          <td>${escapeHtml(r.category || '')}</td>
          <td class="muted">${escapeHtml(r.created_at || '')}</td>
        </tr>
      `).join('');
    }

    function filterRows() {
      const q = document.getElementById('search').value.trim().toLowerCase();
      const type = document.getElementById('typeFilter').value;
      const cat = document.getElementById('categoryFilter').value;
      const filtered = allRows.filter(r => {
        if (type && r.type !== type) return false;
        if (cat && r.category !== cat) return false;
        const hay = `${r.name} ${r.email} ${r.organization}`.toLowerCase();
        return hay.includes(q);
      });
      render(filtered);
    }

    function exportCSV() {
      const headers = ['Type','Name','Email','Phone','Organization','Category','Created At'];
      const rows = Array.from(document.querySelectorAll('#tbody tr'))
        .filter(tr => !tr.querySelector('.empty'))
        .map(tr => Array.from(tr.children).map(td => td.textContent));
      const data = [headers, ...rows];
      const csv = data.map(r => r.map(escapeCsv).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'registrations.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function escapeHtml(s){
      s = s == null ? '' : String(s);
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
      return s.replace(/[&<>"']/g, c => map[c]);
    }
    function escapeCsv(s){
      if (s == null) return '';
      s = String(s);
      if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
      return s;
    }

    document.getElementById('search').addEventListener('input', filterRows);
    document.getElementById('typeFilter').addEventListener('change', filterRows);
    document.getElementById('categoryFilter').addEventListener('change', filterRows);
    document.getElementById('exportBtn').addEventListener('click', exportCSV);
    document.getElementById('refreshBtn').addEventListener('click', load);

    async function load() {
      try {
        const res = await fetch('get_registrations.php');
        const data = await res.json();
        // Normalize
        allRows = [];
        for (const rec of data) {
          if (rec.type === 'single') {
            allRows.push({
              type: 'single',
              name: rec.name || '',
              email: rec.email || '',
              phone: rec.phone || '',
              organization: rec.organization || '',
              category: rec.category || '',
              created_at: rec.created_at || ''
            });
          } else if (rec.type === 'multiple') {
            allRows.push(...normalizeMultiple(rec));
          }
        }
        render(allRows);
      } catch (e) {
        console.error('Failed to fetch registrations:', e);
        allRows = [];
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '<tr><td class="empty" colspan="7">Failed to load registrations. Please try Refresh.</td></tr>';
      }
    }

    load();
  </script>
</body>
</html>
